<!DOCTYPE html>
<html lang="ja" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Vimのパッケージ機能を試してみました - Blank File</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://miyakogi.github.io/blog/20160229/vim_pack.html">

        <meta name="author" content="miyakogi" />
        <meta name="keywords" content="vim" />
        <meta name="description" content="最近dein.vimがバズったりVim本体にパッケージ機能が追加されたり、Vim界隈は第二次プラグインマネージャ戦争の気配に包まれています [要出典]。 dein.vimはすでにいくつか紹介記事がありますが、本体の方はあまり情報を見かけかなかったので先日試した結果を含めて紹介します。 この機能は入ったばかりなので、今後仕様の変更があるかもしれませんし、バグもあるかもしれませんし、（たぶん）機能追加もあると思います。 記事の内容が古くなっているかもしれないので、日付とVimのバージョンをよく確認してください。 試す人は本体のデバッグに自分のVimを捧げる気持ちでいきましょう。 バックアップ重要です。" />

        <meta property="og:site_name" content="Blank File" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Vimのパッケージ機能を試してみました"/>
        <meta property="og:url" content="https://miyakogi.github.io/blog/20160229/vim_pack.html"/>
        <meta property="og:description" content="最近dein.vimがバズったりVim本体にパッケージ機能が追加されたり、Vim界隈は第二次プラグインマネージャ戦争の気配に包まれています [要出典]。 dein.vimはすでにいくつか紹介記事がありますが、本体の方はあまり情報を見かけかなかったので先日試した結果を含めて紹介します。 この機能は入ったばかりなので、今後仕様の変更があるかもしれませんし、バグもあるかもしれませんし、（たぶん）機能追加もあると思います。 記事の内容が古くなっているかもしれないので、日付とVimのバージョンをよく確認してください。 試す人は本体のデバッグに自分のVimを捧げる気持ちでいきましょう。 バックアップ重要です。"/>
        <meta property="article:published_time" content="2016-02-29" />
            <meta property="article:section" content="Vim" />
            <meta property="article:tag" content="vim" />
            <meta property="article:author" content="miyakogi" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://miyakogi.github.io/blog/theme/css/bootstrap.ja.min.css" type="text/css"/>
    <link href="https://miyakogi.github.io/blog/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://miyakogi.github.io/blog/theme/css/pygments/trac.css" rel="stylesheet">
    <link rel="stylesheet" href="https://miyakogi.github.io/blog/theme/css/style.css" type="text/css"/>

        <link href="https://miyakogi.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Blank File ATOM Feed"/>



        <link href="https://miyakogi.github.io/blog/feeds/vim.atom.xml" type="application/atom+xml" rel="alternate"
              title="Blank File Vim ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://miyakogi.github.io/blog/" class="navbar-brand">
Blank File            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://miyakogi.github.io/blog/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://miyakogi.github.io/blog/20160229/vim_pack.html"
                       rel="bookmark"
                       title="Permalink to Vimのパッケージ機能を試してみました">
                        Vimのパッケージ機能を試してみました
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-02-29T17:52:00+09:00"> Mon 29 February 2016</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://miyakogi.github.io/blog/tag/vim.html">vim</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>最近<a href="https://github.com/Shougo/dein.vim">dein.vim</a>がバズったりVim本体にパッケージ機能が追加されたり、Vim界隈は第二次プラグインマネージャ戦争の気配に包まれています <em>[要出典]</em>。
dein.vimはすでにいくつか紹介記事がありますが、本体の方はあまり情報を見かけかなかったので先日試した結果を含めて紹介します。</p>
<p>この機能は入ったばかりなので、今後仕様の変更があるかもしれませんし、バグもあるかもしれませんし、（たぶん）機能追加もあると思います。
記事の内容が古くなっているかもしれないので、日付とVimのバージョンをよく確認してください。</p>
<p>試す人は本体のデバッグに自分のVimを捧げる気持ちでいきましょう。
バックアップ重要です。</p>
<!-- more -->

<p>[2016/03/07: <code>:loadplugin</code>が削除され<code>:packadd</code>が追加されたので修正]</p>
<h2>メリット</h2>
<ul>
<li>プラグインマネージャが裏で色々頑張ってくれていることが理解できる</li>
</ul>
<h2>必要なもの</h2>
<ul>
<li>最新のVim</li>
<li>インストールするプラグイン</li>
<li>たくさんエラーが出てもいいVim環境</li>
<li>エラーやバグに負けない強い心</li>
</ul>
<p>私は Kubuntu 15.10 で試しました。
Vimのバージョンは7.4.1225くらいでした。</p>
<h3>情報源</h3>
<ul>
<li><code>:help packages</code></li>
<li><code>:help :packadd</code></li>
<li><code>:help 'packpath'</code></li>
</ul>
<p>困ったら<a href="https://github.com/vim/vim">ソースコード</a></p>
<h2>とりあえずプラグインを入れてみる</h2>
<p>プラグインを入れるディレクトリは大別して二種類です。</p>
<ul>
<li><code>~/.vim/pack/{好きな名前}/ever</code></li>
<li><code>~/.vim/pack/{好きな名前}/opt</code></li>
</ul>
<p>基本的には<code>ever</code>以下に自動的に読み込んでほしいプラグインを置いて、<code>opt</code>以下に必要な時に読み込む（遅延読込する）プラグインを置く形です。
すでにNeoBundleなどのプラグインマネージャを使っている場合はプラグインが一つのディレクトリにまとまっていると思いますので、その中身をまるっと<code>ever</code>以下にコピーして<code>neobundle#begin()</code>〜<code>neobundle#end()</code>あたりを<code>if 0</code>と<code>endif</code>で囲めばすぐ試せます（微妙な仕様の違いがあるので、そのままだと大量のエラーを経験することになりますが）。</p>
<p>例えばplugin1とplugin2を<code>ever</code>以下に置く場合は次のようなディレクトリ構成になります。</p>
<div class="highlight"><pre><span></span>~/.vim
├── pack
│   ├── mypack
│   │   ├── ever
│   │   │   ├── plugin1
│   │   │   │   ├── autoload
│   │   │   │   ├── plugin
│   │   │   │   └── README.md
│   │   │   ├── plugin2
│   │   │   │   ├── autoload
│   │   │   │   ├── plugin
│   │   │   │   └── readme.md
</pre></div>


<p>この状態でVimを起動すると、<strong>.vimrcなどを読み込んだ後に</strong>自動的にplugin1とplugin2がruntimepathに追加されます。</p>
<p>太字部分重要です。
つまりvimrcの中ではプラグインが定義するコマンドや関数は使えません。
例えば<code>NoeBundle ~</code>とかやっていた部分は全滅します。
autoload関数も使えないので、設定で<code>call plugin#setup(...)</code>などとしている部分も全滅です。
また、プラグインもロードされていないので、例えば<code>if neobundle#is_installed('プラグイン名')</code>などのかわりに単純に<code>if get(g:, 'loaded_プラグイン名')</code>などと置き換える事もできません。
値の設定（<code>let g:superplugin_default_option = 1</code>など）は大丈夫です。</p>
<p>私はこれを回避するために、プラグインを使っている部分を別ファイルに分離してオートコマンドで<code>VimEnter</code>時に読み込むようにしました。
<code>~/.vim/after/plugin</code>以下も試してみましたが、ここもパッケージのロードより先に読み込まれていました。
最終的にはプラグインを使う設定を<code>~/.vim/config/plugins.vim</code>に書いて、次のような設定をvimrcに追加しました。</p>
<div class="highlight"><pre><span></span><span class="k">if</span> filereadable<span class="p">(</span>expand<span class="p">(</span><span class="s1">&#39;~/.vim/config/plugins.vim&#39;</span><span class="p">))</span>
  autocmd myvimrc <span class="nb">VimEnter</span> * source <span class="p">~</span><span class="sr">/.vim/</span>config/plugins.<span class="k">vim</span>
<span class="k">endif</span>
</pre></div>


<p>これで<code>plugins.vim</code>の中ではプラグインが使えます。
インストールの確認も<code>if get(g:, 'loaded_~')</code>や<code>if exists(':PluginCommand')</code>などでできます。
<code>g:loaded_~</code>を設定しないプラグインは、とりあえず<code>if match(&amp;runtimepath, 'プラグイン名')</code>で確認しています。</p>
<p>注意する点は、オプション値の設定（<code>let g:~~~ = ...</code>と設定するタイプ）はvimrc内に書いたほうが安全ということです。
読み込み時に設定値のチェックをしてそのまま使っているプラグインが結構あるようで、それらがロードされる前に値の設定を済ませる必要があるからです。</p>
<h3>読み込まれないプラグイン対策</h3>
<p>現在は<code>plugin</code>ディレクトリがないプラグインは読み込まれない（runtimepathに追加されない）ようです。
これはautoload関数だけを提供しているプラグイン（<a href="https://github.com/kana/vim-textobj-user">textobj-user</a>など）やカラースキーム（<a href="https://github.com/altercation/vim-colors-solarized">solalized</a>など）、スニペット集（<a href="https://github.com/Shougo/neosnippet-snippets">neosnippet-snippets</a>）などが該当し、読み込まれません。
これが仕様として確定するのかわかりませんが、私はとりあえずの回避策として<code>mkdir plugin &amp;&amp; touch plugin/_.vim</code>と適当にファイルを作って置きました。</p>
<p>また、<code>plugin</code>直下に<code>*.vim</code>ファイルがなく、さらにディレクトリがあるようなプラグインも読み込まれませんでした。
仕様なのか微妙ですが、runtimepathには追加されているのでバグのような気がします。
ありがたいことに<a href="https://github.com/vim-jp/issues/issues/848">動作確認とIssue報告</a>までしていただいたので、7.5のリリースまでに修正されるのではないかと。。。
これも上記と同様に適当なファイル（<code>*.vim</code>）をpluginディレクトリに置くことで読み込み可能です。</p>
<h2>遅延読み込み</h2>
<p><code>opt</code>以下のプラグインはそのままでは読み込まれません。
<code>:packadd {プラグインのディレクトリ名}</code>を実行して初めて有効になります。</p>
<p>私はとりあえずインサートモードで使うプラグインを<code>opt</code>に置き、以下のような設定を行いました。</p>
<div class="highlight"><pre><span></span><span class="k">function</span><span class="p">!</span> s:lazy_load_insert<span class="p">()</span> abort
  loadplugin delimitMate
  loadplugin <span class="k">vim</span><span class="p">-</span>smartchr
  loadplugin ...
  ...
<span class="c">  &quot; マッピングなどの設定があればする</span>
  <span class="k">call</span> s:init_delimitMate<span class="p">()</span>

<span class="c">  &quot; 二回目以降実行されないようにautocmdを削除</span>
  autocmd<span class="p">!</span> lazy_load_i
<span class="k">endfunction</span>

augroup lazy_load_i
  autocmd<span class="p">!</span> <span class="nb">InsertEnter</span> * <span class="k">call</span> s:lazy_load_insert<span class="p">()</span>
augroup END
</pre></div>


<p>NeoBundleはコマンド実行や関数呼び出しやマッピングをトリガにして遅延読み込みできますが、大変そうだったのでそこまでやっていません。
起動時間に露骨に影響するようなプラグインはそもそも入れてないというのもありますが。
（NERDTreeやsyntasticは読み込みに結構時間かかるので使っていません）</p>
<h2>起動時間</h2>
<p>みなさん気になると思います。
ざっくり雑に測っただけですが、とりあえず遅延読み込みしないで全部読み込むような条件ではdein.vimと同じか少し速いくらい、NeoBundleより30~40%速い感じでした。
ただ、上に書いたように読み込まれないプラグインがけっこうあって、気づいたものは対策しましたがまだ読み込まれていないものもありそうなので、実際にはdein.vimと同じくらいじゃないかと思います。</p>
<p>余談ですが、Vimの起動時間が気になる人は（もしやっていないなら）ファイルタイプの設定を自前で用意してデフォルトの<code>filetype.vim</code>を読まないようにするといいと思います。
デフォルトの設定だと人生で一度も使わないであろうファイルタイプの設定が大量にあるので。
デフォルトの<code>filetype.vim</code>は<code>share/vim/vim74/filetype.vim</code>にあります。
ここから必要そうな設定を拝借してvimrcで設定するなりして、<code>let g:did_load_filetypes=1</code>しておけばデフォルトのファイルタイプ設定は読まれなくなります。</p>
<h2>まとめ</h2>
<p>NeoBundleがメンテナンスモードに入ると聞いてdein.vimへの移行を考えている方、どうせプラグイン周りの設定をいじるならついでに本体のパッケージ機能も試してみませんか？
いっしょに人柱してバグを探しましょう。</p>
            </div>
            <!-- /.entry-content -->
    <hr />
    <!-- AddThis Button BEGIN -->
    <div class="addthis_toolbox addthis_default_style">
            <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
            <a class="addthis_button_tweet"></a>
            <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    </div>
    <!-- AddThis Button END -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/miyakogi"><i class="fa fa-github-square fa-lg"></i> github</a></li>
                <li class="list-group-item"><a href="https://twitter.com/MiyakoDev"><i class="fa fa-twitter-square fa-lg"></i> twitter</a></li>
              </ul>
            </li>

            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
                <ul class="list-group" id="recentposts">
                    <li class="list-group-item">
                        <a href="https://miyakogi.github.io/blog/20160406/wdom_intro.html">
                            PythonでブラウザベースのGUIアプリを作るライブラリ、WDOMの紹介
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="https://miyakogi.github.io/blog/20160308/vimpack_py.html">
                            Vimのパッケージをインストール・アップデートしてヘルプ作るスクリプトを書きました
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="https://miyakogi.github.io/blog/20160229/vim_pack.html">
                            Vimのパッケージ機能を試してみました
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="https://miyakogi.github.io/blog/20160215/static_site_generators.html">
                            Python製の静的サイトジェネレータを色々試してみました
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="https://miyakogi.github.io/blog/20160214/livemark_update.html">
                            Livemark.vimを色々更新しました
                        </a>
                    </li>
                </ul>
            </li>

            <li class="list-group-item"><a href="https://miyakogi.github.io/blog/"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Categories</span></h4></a>
                <ul class="list-group" id="categories">
                    <li class="list-group-item">
                        <a href="https://miyakogi.github.io/blog/category/python.html">
                            <i class="fa fa-folder-open fa-lg"></i> Python
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="https://miyakogi.github.io/blog/category/vim.html">
                            <i class="fa fa-folder-open fa-lg"></i> Vim
                        </a>
                    </li>
                </ul>
            </li>

            <li class="list-group-item"><a href="https://miyakogi.github.io/blog/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group " id="tags">
                    <li class="list-group-item tag-0">
                        <a href="https://miyakogi.github.io/blog/tag/python.html">
                            python
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://miyakogi.github.io/blog/tag/vim.html">
                            vim
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://miyakogi.github.io/blog/tag/static-site-generator.html">
                            static site generator
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://miyakogi.github.io/blog/tag/ci.html">
                            CI
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://miyakogi.github.io/blog/tag/wdom.html">
                            wdom
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://miyakogi.github.io/blog/tag/pelican.html">
                            pelican
                        </a>
                    </li>
                </ul>
            </li>



    <li class="list-group-item"><h4><i class="fa fa-twitter fa-lg"></i><span class="icon-label">Latest Tweets</span></h4></li>
    <div id="twitter_timeline">
        <a class="twitter-timeline" data-chrome="noheader" href="https://twitter.com/miyakodev" data-widget-id="695483665627766784">Tweets by miyakodev</a>
    </div>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://python.org/" target="_blank">
                Python.org
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://getpelican.com/" target="_blank">
                Pelican
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 miyakogi
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://miyakogi.github.io/blog/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://miyakogi.github.io/blog/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://miyakogi.github.io/blog/theme/js/respond.min.js"></script>

    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-59101475-2']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

        <script type="text/javascript">var addthis_config = {"data_track_addressbar": true};</script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-56b43892ef18a159"></script>
</body>
</html>